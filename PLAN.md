# Plan
Last updated: 2026-01-31

## 项目概述
pic_tools 是一个轻量的 Python 命令行工具，用于在**不裁剪**、尽量保持清晰度的前提下，将图片压缩到指定大小（KB 上限），重点适配横幅类图片的常见需求（例如将 1.6MB 压到 ~70–80KB 的 WebP）。

## 目标与成功标准（Success Criteria）
- 能稳定将常见输入图片压到 `--target-kb` 指定的**最大文件大小**以内（若受格式/最小边限制无法达到，应明确提示与返回非 0 退出码或清晰告警）。
- 保持长宽比、不裁剪；若需要降尺寸，采用渐进策略并可控（最小边限制生效且行为可预测）。
- 默认策略“开箱即用”：默认输出格式与透明处理符合直觉，文档与实际行为一致。
- CLI 体验可靠：参数语义清晰、错误信息可操作、输出结果可追溯（尺寸/格式/质量等摘要信息稳定）。
- 可维护与可回归：关键场景有最小测试集与样例资产，支持在自动化闭环中快速迭代。

## 范围（Scope）
- 单图压缩核心能力：目标大小、质量递减与必要时的尺寸递减、最大宽高限制、透明通道处理与底色控制。
- 输出格式：JPEG / WebP / PNG（明确各格式特性与限制，避免对“PNG 一定能压到很小”产生误解）。
- 工程与文档：README（中英文一致性）、示例、参数说明、回归测试与基本 CI/脚本化运行。

## 非目标（Non-goals）
- 不做裁剪、内容感知重排、智能抠图等编辑能力。
- 不追求“所有图片都能在极低 KB 下仍清晰”的感知最优（以可控策略与明确取舍为主）。
- 不引入重量级依赖或外部二进制链路作为默认必选项（保持 Pillow + Python 为主）。
- 暂不承诺 GUI 应用或多平台安装器（可作为后续扩展评估）。

## 里程碑与路线图（Roadmap）
1) 策略与语义定型（对外契约稳定）
   - 明确 `--target-kb` 的语义（上限 vs “尽量接近”）与默认格式选择规则（含透明与插画/文本场景的预期）。
   - 对齐实现与文档：行为一致、边界清晰、失败场景可解释。

2) 核心压缩质量与鲁棒性提升
   - 优化质量搜索与降尺寸策略（在满足大小前提下尽量保持清晰度，减少“过度压小/过度降质”的概率）。
   - 覆盖更多色彩/透明模式与异常输入处理（包括透明 PNG、调色板模式等），确保输出稳定。

3) CLI 与文档完善（面向可用性）
   - 增强可观测性与可诊断性（输出摘要、可选 verbose/quiet、明确的错误提示与退出码约定）。
   - README 示例覆盖典型用法与“选项组合最佳实践”，并保持中英文内容一致。

4) 回归测试与样例资产（保证不回退）
   - 建立最小回归集：典型横幅、透明图、插画/文本、超大图、PNG 强制输出等关键场景。
   - 在本地与自动化流程中可一键运行，便于迭代时快速验证。

5) 批量处理与工作流集成
   - 评估并实现批量处理入口（多文件/目录/递归/通配），并定义输出命名与覆盖策略。
   - 形成可复用的预设/配置方式（命令行优先，必要时支持读取配置文件），避免参数组合复杂度失控。

6) 工程化发布准备
   - 明确发布形态（单脚本 vs Python 包/入口命令），补齐版本与发布流程（如引入 CI、发布校验）。
   - 兼容性验证（不同 Pillow 构建对 WebP 支持差异等）并提供清晰的 fallback 行为。

## 近期优先级（Immediate Next Priorities）
- 先把“对外契约”定清：`--target-kb` 语义、默认格式选择与透明处理规则，保证实现与文档一致。
- 聚焦鲁棒性与回归：补齐关键输入模式覆盖与最小测试集，确保每轮迭代不回退。
- 规划批量处理的产品形态：先做需求分层（单图稳定 → 批量入口 → 配置/预设），避免过早扩展导致复杂度上升。

## 风险与缓解（Risks & Mitigations）
- 目标 KB 与观感冲突：极低目标可能迫使降尺寸/降质，影响清晰度  
  - 缓解：明确策略优先级与最小边限制；在无法满足目标时给出可操作建议（提高目标、改用 WebP、放宽尺寸限制等）。
- 格式差异导致“不可达目标”：PNG 为无损，单靠压缩级别难以显著变小  
  - 缓解：文档明确 PNG 限制；必要时建议转 WebP/JPEG；在 PNG 强制输出时给出达成概率提示。
- Pillow/WebP 支持不一致：不同环境的 Pillow 构建可能缺少 WebP 编解码能力  
  - 缓解：启动时自检/捕获异常并给出 fallback（例如退回 JPEG）与明确提示。
- 自动策略不符合用户直觉：默认格式/底色/透明处理可能引发预期偏差  
  - 缓解：把默认策略写成明确规则；提供易发现的覆盖参数；用示例解释“为什么这样选”。

## 假设与开放问题（Assumptions & Open Questions）
- `--target-kb` 作为“最大值”是否足够，还是需要提供“尽量接近目标”的优化模式（例如更细粒度搜索/二分）？
- 默认格式选择是否需要更智能（透明 PNG、插画/文本、照片等场景），以及判定信号应基于哪些可解释特征？
- 是否需要批量处理/目录递归作为近期需求，还是保持单图工具并鼓励 shell 批处理？
- 发布形态是否需要升级为可安装 CLI（entrypoint），以及版本/兼容性策略的优先级如何？

## Progress Tracking (Auto-updated)
<!-- AUTO-PROGRESS:START -->
[DONE] 明确产品语义与默认策略（target-kb 语义、默认格式与透明处理规则）
[DOING] 提升压缩效果与鲁棒性（质量搜索、缩放策略、边界模式兼容）
[DONE] 完善 CLI 与文档体验（参数契约、示例与中英文一致性）
[DOING] 引入回归测试与样例资产（关键场景覆盖、自动化可运行）
[DOING] 批量处理与可配置化（多文件/目录、预设/配置、输出策略）
[DOING] 工程化发布准备（打包/版本、CI、兼容性验证）
<!-- AUTO-PROGRESS:END -->
